# Order
This doc describes the design of order service.

## 1. Basic Features


## 2. Model Design
- View model: [View Model](./api.md)

### 2.1. Order number design
In order model, we store a long number named `orderNumber` and use it to
identify the placed order. Each time a new order is placed, a `orderNumber` will
be generated which will be shown to customer, here is the rule:

1. use `SecureRandom` to generate 8 random bytes.

2. convert 8 random bytes to long number.

3. because the range of orderNumber is required to be less than 10 billion, so
   makes the long number right shift 31 bits to get 33 bits number(maximum value
   is 8589934592, less than 10 billion)
   
4. the value we get above may be negative, so that calls `Math.abs()` to ensure
   it is positive

5.  save it to `orderNumber`

Noting that: the orderNumber must be unique, but the number generated by
`secureRandom` may be same, which will break unique constrain. So when this
situation occurs, regenerate a new orderNumber and save it again.

## 3. Workflow

## 4. Event Design
This part describes the events that this service produce or consume.

### 4.1 Producer Of Place Order Event
When the customer place an order, then this system will produce a event.

#### 4.1.1  Topic
`reactivesw-order-created`
#### 4.1.2 Topic Model
- Message Data:
```java
  String orderId;

  String paymentMethodId;
  
  String shippingAddressId;
  
  List<InventoryRequest> iventoryRequests;
  
  Money totalAmount;
```
- InventoryRequest:
```java
  String sku;
  Integer quantity;
```
- Money:
```java
  String currencyCode;
  String centAmount;
```


### 4.2 Consumer Of Order Payed Event
When an order is payed by `payment` service, it will produce an event, the order service consume this event, and change order's status.
#### 4.2.1 Subscribe
`order-payment-payed`
#### 4.2.2 Model

#### 4.2.3 Workflow
1. get order id, payment id, pay result and result message from event message
2. validate if the order with order id
3. change order's status and save the pay result

### 4.3 Consumer Of Order Reserved Event
When an order is reserved by inventory service, it will produce an event, the order service consume this event, and change order's status.
#### 4.3.1 Subscribe
`order-inventory-reserved`
#### 4.3.2 Model

#### 4.3.3 Workflow
1. get order id, reserve result event message
2. validate if the order with order id
3. change order's status and save the reserved result
